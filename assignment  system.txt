Assignment System Implementation Guide
=====================================

Overview
--------
This guide reverse-engineers the assignment workflow implemented in the VEA 2025 project so you can brief another Codex-class agent to reproduce an equivalent experience. It covers the core data contracts, storage strategy, API expectations, domain behaviours, notification logic, and user-facing journeys across teacher and student dashboards. No code is provided; instead, you will find explicit directives about what to build, how the moving pieces collaborate, and where edge cases are handled.

High-Level Architecture
-----------------------
1. **State orchestration via a database manager service**: A rich client-side service (referred to here as `dbManager`) centralises persistence, domain rules, and event emission for assignments, submissions, reminders, and notifications. Replicate its responsibilities in your target project.
2. **Optional server round-trips**: The system can operate entirely from a safe local storage cache, but when `NEXT_PUBLIC_ENABLE_REMOTE_API === "true"` and a `fetch` implementation exists, the manager proxies CRUD actions to `/api/assignments`. Ensure both offline-first storage and remote synchronisation are supported.
3. **Event-driven UI updates**: UI surfaces subscribe to manager events such as `assignmentsUpdate` and `assignmentSubmitted`. Rebuild an equivalent emitter/subscriber pattern so dashboards automatically reflect new data without manual refreshes.
4. **Notification side-effects**: Assignment lifecycle changes spawn contextual notifications for teachers and students. Capture the logic flow and metadata structure so the notification center mirrors the same behaviour.
5. **Reminder throttling**: A dedicated reminder log tracks which due-date nudges were already sent to prevent duplicates. Port the same guardrails.

Domain Model Contracts
----------------------
### Assignment records
Create a canonical `AssignmentRecord` object with the following shape and semantics:
- `id`: unique string generated by the manager when not provided by the server.
- `title`, `description`, `subject`: user-authored metadata (fallbacks to non-empty strings when missing).
- `classId`/`className`: links the assignment to a class; both are nullable, but at least one is preferred for roster resolution.
- `teacherId`/`teacherName`: optional identity of the creator.
- `dueDate`: ISO string; required and normalised to prevent invalid timestamps.
- `status`: finite set {`draft`, `sent`, `submitted`, `graded`, `overdue`} with coercion to `draft` when unknown.
- `maximumScore`: nullable number derived from strings or numbers; used for grading UI and validation.
- `assignedStudentIds`: array of student IDs explicitly targeted; normalised to trimmed strings.
- `submissions`: array of `AssignmentSubmissionRecord` (see below).
- `resourceName`, `resourceSize`, `resourceType`, `resourceUrl`: optional attachment metadata stored alongside the assignment.
- `createdAt`, `updatedAt`: ISO timestamps stamped by the manager.

### Submission records
Define `AssignmentSubmissionRecord` with:
- `id`: unique identifier (persist existing IDs if provided, otherwise mint a new token).
- `assignmentId`, `studentId`: required string references.
- `status`: {`pending`, `submitted`, `graded`} defaulting to `submitted`.
- `submittedAt`: ISO timestamp or `null`.
- `files`: array of file descriptors `{ id, name, url? }` (strings promote to file names automatically).
- `comment`: optional textual feedback from the student or teacher.
- `grade`, `score`: optional grading outcomes; `score` coerced to number or `null`.

### Filters and payloads
- `AssignmentFilters` accepts `teacherId`, `studentId`, `classId`, `assignmentId` as strings.
- `CreateAssignmentInput` mirrors assignment fields but without `id`, `submissions`, or timestamps; includes optional `assignedStudentIds` and attachment details.
- `CreateAssignmentSubmissionInput` captures the payload students send when submitting.

Storage and Normalisation Rules
-------------------------------
1. **Local cache**: Persist assignments in a JSON array stored under the `safeStorage` key `"assignments"`. When reading, clean malformed entries, ensure arrays exist, coerce numeric fields, and drop invalid submissions.
2. **Remote sync**: When remote APIs are enabled, build URLs with query parameters for filters (`teacherId`, `studentId`, `classId`, `assignmentId`) and fetch `/api/assignments`. Merge remote payloads into the local cache, de-duplicating by `id` and signature `(teacher,title,dueDate)`.
3. **Status adjustments**: Convert statuses to lowercase, fall back to `draft`, and mark assignments as `overdue` for students when the due date has passed and no submission exists.
4. **Class roster resolution**: When `assignedStudentIds` is empty, infer recipients from the class using a helper that looks up students by class label.
5. **Attachment handling**: Always store attachment metadata even if only a file name is supplied; convert sizes from strings to numbers.
6. **Timestamp stamping**: For any create or update, refresh `updatedAt` with the current ISO string; set `createdAt` when records first appear.

API Surface Expectations
------------------------
Implement Next.js-style route handlers (or equivalent) with these responsibilities:
1. `GET /api/assignments`: Accept query parameters for `teacherId`, `studentId`, `classId`, `assignmentId`. Return `{ assignments }` from the manager.
2. `POST /api/assignments`: Distinguish between assignment creation and submission via a `type` field. When `type === "submission"`, call `createAssignmentSubmission`; otherwise call `createAssignment`. Normalise action verbs (`draft`, `save`, `sent`, `send`) before dispatch.
3. `PATCH /api/assignments`: Require `assignmentId` and an `updates` object; forward to `updateAssignment`.
4. `DELETE /api/assignments`: Accept the identifier via query string or JSON body and forward to `deleteAssignment`.
5. Respond with consistent success messages and HTTP status codes; log errors server-side and return 500 with a generic message on failure.

Database Manager Responsibilities
---------------------------------
Reproduce the following capabilities inside the central manager service:
1. **Storage utilities**: `ensureAssignmentsStorage`, `persistAssignments`, `replaceAssignmentsCache`, `syncAssignmentCache`, `removeAssignmentFromCache`.
2. **Remote toggle checks**: `shouldUseAssignmentsApi` gating all network paths.
3. **Normalisers**: `normaliseAssignmentPayload`, `normaliseAssignmentSubmission`, `normaliseAssignmentStatus`, `normaliseNumericValue`, `normalisePersonName`.
4. **Rosters and metadata**:
   - `resolveAssignmentStudentIds` to auto-populate `assignedStudentIds` from class membership.
   - `resolveUserSummary` / `resolveStudentInfo` to hydrate notification metadata (names, classes, roles).
   - `resolveClassMetadata` to map ambiguous class identifiers to canonical IDs/names (rely on class registry helpers).
5. **Event dispatching**: After any mutation, trigger `assignmentsUpdate` with a payload describing the affected assignment or submission. On submission, emit both `assignmentsUpdate` and `assignmentSubmitted`.
6. **Notification hooks**:
   - `notifyAssignmentSent`: When status becomes `sent`, notify each student (direct recipients or entire class) and the teacher. Use `describeAssignmentDueDate` to append friendly due phrases.
   - `notifyAssignmentSubmission`: When a student submits, inform the teacher and the student.
   - `notifyAssignmentGraded`: When graded, inform both parties, summarising the score/grade.
7. **CRUD operations**:
   - `getAssignments` handles filtering, status derivation, overdue detection, and submission decoration for students.
   - `createAssignment` adds new records, optionally calling the API, and notifies on `sent` status.
   - `updateAssignment` merges updates, recalculates recipients when necessary, and notifies when a draft transitions to `sent`.
   - `updateAssignmentStatus` is a thin wrapper.
   - `deleteAssignment` removes records, synchronises caches, and emits an update event.
   - `createAssignmentSubmission` records or updates submissions, preserves file metadata, emits events, and triggers notifications.
   - `gradeAssignmentSubmission` transitions submission status to `graded`, updates scores/comments, notifies both audiences, and emits an event.
   - `submitAssignment` is a convenience wrapper that also updates legacy per-student submission caches.

Reminder Throttling
-------------------
Mirror the `lib/assignment-reminders.ts` helpers:
1. Maintain a JSON map `{ teacher: { [assignmentId]: { [type]: { timestamp, dueDate } } }, student: { ... } }` under the key `assignmentReminderLog`.
2. `shouldSendAssignmentReminder(audience, assignmentId, type, { dueDate? })` returns `true` if no prior entry exists or the due date changed.
3. `markAssignmentReminderSent` records the reminder dispatch with the due date.
4. `clearAssignmentReminderHistory` wipes entries entirely or per type, ensuring reminders can be resent when appropriate.

Teacher Dashboard Experience
----------------------------
Recreate the comprehensive teacher workflow provided by `components/teacher-dashboard.tsx`:
1. **Assignment tab navigation**: A tabbed interface shows insights, the assignment roster, and action buttons (`Create Assignment`, `Refresh assignments`).
2. **Insights summary**: Compute counts for total assignments, drafts vs active, submission rate, pending grading count, and average score using `assignmentInsights` logic (iterate over assignments and submissions, considering maximum capacity derived from `assignedStudentIds` or submissions).
3. **Assignment list cards**:
   - Display subject, class, title, description, due date, relative due string, maximum score, attachment badge, and last updated timestamp.
   - Show progress chips for submissions (`submitted/expected`) and grading state.
   - Provide action buttons: preview (student view), view submissions, edit, send (if draft), delete.
   - Indicate status with a stylised badge referencing a metadata map (colours/text per status).
4. **Creation/edit dialog**:
   - Form fields: title, description (rich text friendly), subject select (populated from teacher subject assignments), class select (teacher classes), due date/time, maximum score, resource upload (store `resourceName`, `resourceType`, `resourceSize`, `resourceUrl`), optional manual student selection.
   - Submit actions: `Save as draft` and `Send to class`, dispatching to manager with appropriate status.
   - Support editing existing assignments by pre-filling form and toggling between statuses.
5. **Roster resolution**: When viewing submissions, resolve the list of students assigned via `resolveAssignmentRoster`. Include class-level fallbacks and handle errors gracefully with toast notifications.
6. **Submission management**:
   - Display submission table with student names, submission timestamps, comments, attachments, and grade/score inputs.
   - Allow inline grading: update scores (bounded by `assignment.maximumScore` or the column maximum), assign grades, add teacher feedback, and persist via `dbManager.gradeAssignmentSubmission`.
   - After grading, sync results into report card storage (`mapReportCardRecordToRaw`, `readStudentMarksStore`, etc.), ensuring CA/assignment scores integrate with the academic record.
7. **Attachment download**: Provide download links for assignment resources using `resourceUrl` and `resourceName`.
8. **Event subscriptions**: Register listeners on `assignmentsUpdate` to refresh UI state and clean up on unmount.
9. **Toast feedback**: Surface success/error states using the shared toast hook, matching copy such as “Assignment created successfully” or “Unable to delete assignment.”
10. **Reminder prompts**: Use the reminder helpers to decide when to surface due-soon or grading-pending nudges to the teacher, resetting history when assignments are updated or graded.

Student Dashboard Experience
----------------------------
Replicate the student view logic in `components/student-dashboard.tsx`:
1. **Assignment fetching**: Request assignments via `dbManager.getAssignments({ studentId })` and normalise records for display. Listen for `assignmentsUpdate` and `assignmentSubmitted` to keep the list current.
2. **Status interpretation**: For each assignment, derive user-facing status metadata (colour, text). Mark assignments as `overdue` when due date < now and no submission.
3. **Assignment cards**:
   - Show title, subject, teacher, due date, marks, description, due countdown, attachments, submission history (uploaded file name/link, comment, submitted timestamp, grade/score).
   - Provide CTA buttons to `View details`, `Download assignment`, or `Submit/Resubmit` depending on status.
4. **Submission modal**:
   - Allow students to attach one file (store as descriptor), add a comment, and confirm submission. Prevent duplicate submissions by updating the local state and reusing `dbManager.submitAssignment` (which wraps `createAssignmentSubmission`).
   - After submission, show a confirmation message and update the card to reflect `submitted` status and timestamps.
5. **Teacher filtering**: Build a quick filter that narrows assignments by the student’s subject teachers. Tokenise teacher identifiers and names to match across fields.
6. **Progress summary**: Display top-level metrics (assignments assigned, submitted, grading status) mirroring the `assignmentStats` calculations.
7. **Calendar integration**: Convert assignment due dates into upcoming events for the combined calendar view.
8. **Attachment downloads**: Offer download buttons for assignment resources and submitted files (if `resourceUrl` or `submittedFileUrl` exist).

Notifications and Messaging
---------------------------
1. On assignment sent: notify each student (audience `[studentId, "student"]`) and the teacher (`[teacherId, "teacher"]`) with metadata including assignment ID, class, subject, due date, teacher name, and targeted student IDs.
2. On submission: notify the teacher of the submission and the student confirming receipt.
3. On grading: notify the student about their score/grade and the teacher that the mark has been recorded. Ensure `scoreLabel` strings follow the `score/maximum` or grade fallback pattern.
4. Notifications should categorise under `task`, use `info`/`success` severity, and combine descriptive sentences with due-date phrases where applicable.

Status Workflow Summary
-----------------------
1. **Draft**: Created but not shared. Visible only to teachers. Transitions via manual “Send” action or status update.
2. **Sent**: Shared with class; triggers notifications. Students can see and submit. Overdue state overlays when due date lapses without submission.
3. **Submitted**: Student-specific status once they submit. Assignment status remains `sent` globally.
4. **Graded**: Submission-level status after teacher grading; updates student view and notifications.
5. **Overdue**: Calculated client-side for students when due date < now and no submission.

Edge Case Handling
------------------
1. **Invalid data from storage**: Catch JSON parse errors, log them, clear storage, and recover with empty arrays.
2. **Missing IDs**: Abort operations that require `assignmentId` or `studentId` with user-friendly error messages and HTTP 400 responses.
3. **Remote API failures**: Log errors, fall back to local cache, and surface toast notifications to the user.
4. **Duplicate recipients**: Use maps/sets to dedupe student notification recipients when assignments target entire classes.
5. **Score validation**: Clamp grades within `[0, maximumScore]`, warn when exceeding, and round display values.
6. **Reminder resets**: Clear reminder history when assignments are deleted or significantly changed to avoid stale throttling.

Testing & Verification Checklist
--------------------------------
1. **Manager unit tests**: Cover creation, updating, deletion, submission, grading, notification triggers, and reminder logic.
2. **API integration tests**: Ensure CRUD endpoints process payloads correctly and handle missing parameters gracefully.
3. **Teacher UI smoke tests**: Validate creating drafts, sending assignments, editing, previewing, grading, and deleting with toast feedback.
4. **Student UI smoke tests**: Validate viewing assignments, submission flow, re-submission, overdue tagging, and notifications.
5. **Event propagation**: Confirm that submitting or grading updates both teacher and student views without a full reload.
6. **Reminder flow**: Simulate due-soon and overdue scenarios to verify reminders respect throttling.
7. **Attachment handling**: Test uploads, downloads, and fallback messaging when attachments are missing.

Implementation Handoff Notes
---------------------------
- Keep the naming conventions and copy aligned with the original system (e.g., “Assignment created successfully”, “Students can now view and submit this assignment”).
- Ensure all helper utilities (`normalizeClassName`, `normalizeSubjectList`, report card sync helpers) are available or stubbed with equivalent functionality.
- Use consistent date formatting helpers (`formatExamDate`, `describeDueDate`) so due-date messaging matches the rest of the platform.
- Maintain compatibility with both safeStorage-backed operation and remote API usage by checking the environment toggle early inside manager methods.
- Document each public manager method so future developers know the required payload contracts and side effects.

